<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Conversation App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container with-sidebar">
        <!-- Sidebar for Conversation History -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Conversation History</h2>
                <div class="sidebar-actions">
                    <button id="newConversationBtn" class="action-button" title="New Conversation">
                        <span class="action-icon">+</span>
                    </button>
                    <button id="refreshConversationsBtn" class="action-button" title="Refresh conversations">
                        <span class="action-icon">↻</span>
                    </button>
                </div>
            </div>
            <div class="conversation-list" id="conversationList">
                <!-- Conversation history will be loaded here -->
                <div class="empty-state">No saved conversations</div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <header>
                <h1>Can you guess what's wrong with me?</h1>
                <div class="simulation-selector">
                    <label for="simulationSelect">Select Patient Simulation (Optional):</label>
                    <select id="simulationSelect">
                        <option value="">No simulation</option>
                        <option value="" disabled>Loading simulations...</option>
                    </select>
                </div>
                <div class="voice-selector">
                    <label for="voiceSelect">Select Voice:</label>
                    <select id="voiceSelect">
                        <option value="Fritz-PlayAI">Fritz (Default)</option>
                        <option value="Cillian-PlayAI">Cillian</option>
                        <option value="Arista-PlayAI">Arista</option>
                        <option value="Celeste-PlayAI">Celeste</option>
                        <option value="Mamaw-PlayAI">Bill</option>
                        <option value="Cheyenne-PlayAI">Emily</option>
                    </select>
                </div>
                <p class="status" id="status">Ready</p>
            </header>
            
            <main>
                <div class="conversation" id="conversation">
                    <!-- Conversation messages will be displayed here -->
                </div>
                
                <!-- ❷ NEW  insert in exactly the same place -->
                <div class="controls">
                    <button id="autoListenBtn" class="record-button">
                        <span class="record-icon"></span>
                        Auto Listen
                    </button>
                </div>

            </main>
            
            <footer>
                <p>Powered by Groq API</p>
            </footer>
        </div>
    </div>
    
   <!-- Load ONNX Runtime and VAD library first -->
   <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.22/dist/bundle.min.js" 
           onload="console.log('VAD library loaded successfully')" 
           onerror="console.error('Failed to load VAD library')"></script>
   
   <!-- Enhanced library checking and main script loading -->
   <script>
       // Function to check what's available on window
       function debugWindowObjects() {
           console.log('=== WINDOW OBJECT DEBUGGING ===');
           console.log('ONNX Runtime (ort):', typeof ort !== 'undefined');
           console.log('MicVAD:', typeof MicVAD !== 'undefined');
           console.log('window.MicVAD:', typeof window.MicVAD !== 'undefined');
           
           // Check for other possible VAD-related objects
           const vadRelated = Object.keys(window).filter(key => 
               key.toLowerCase().includes('vad') || 
               key.toLowerCase().includes('mic') ||
               key.toLowerCase().includes('voice')
           );
           console.log('VAD-related window properties:', vadRelated);
           
           // Check what's actually in the window
           console.log('All window properties containing "VAD":', Object.keys(window).filter(k => k.includes('VAD')));
           console.log('=== END DEBUGGING ===');
       }

       // Wait for DOM and then check libraries
       window.addEventListener('DOMContentLoaded', () => {
           console.log('DOM loaded, checking library availability...');
           
           // Initial check
           debugWindowObjects();
           
           // Wait longer for libraries to fully initialize
           let attempts = 0;
           const maxAttempts = 50; // 5 seconds total
           
           function checkAndLoadMain() {
               attempts++;
               console.log(`Attempt ${attempts}: Checking for MicVAD...`);
               
               // Check multiple possible locations for MicVAD
               const micVADAvailable = (
                   typeof window.MicVAD !== 'undefined' ||
                   typeof MicVAD !== 'undefined' ||
                   (window.vad && window.vad.MicVAD)
               );
               
               if (micVADAvailable || attempts >= maxAttempts) {
                   if (micVADAvailable) {
                       console.log('✅ MicVAD is now available! Loading main script...');
                       
                       // Make sure MicVAD is available globally
                       if (typeof window.MicVAD === 'undefined' && typeof MicVAD !== 'undefined') {
                           window.MicVAD = MicVAD;
                           console.log('✅ Assigned MicVAD to window.MicVAD');
                       }
                   } else {
                       console.error('❌ MicVAD still not available after maximum attempts');
                       debugWindowObjects();
                   }
                   
                   // Load main script (remove type="module" to fix scope issues)
                   const script = document.createElement('script');
                   script.src = "{{ url_for('static', filename='js/main.js') }}";
                   script.onload = () => console.log('Main script loaded successfully');
                   script.onerror = () => console.error('Failed to load main script');
                   document.body.appendChild(script);
               } else {
                   // Wait 100ms and try again
                   setTimeout(checkAndLoadMain, 100);
               }
           }
           
           // Start checking after a brief delay
           setTimeout(checkAndLoadMain, 200);
       });
   </script>

   <!-- Alternative VAD library loading -->
   <script>
       // Load VAD library with Promise-based approach
       function loadVADLibrary() {
           return new Promise((resolve, reject) => {
               const script = document.createElement('script');
               script.src = 'https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.22/dist/bundle.min.js';
               
               script.onload = () => {
                   console.log('VAD script loaded, waiting for MicVAD...');
                   
                   // Poll for MicVAD availability
                   let checks = 0;
                   const checkForMicVAD = () => {
                       checks++;
                       if (typeof window.MicVAD !== 'undefined' || typeof MicVAD !== 'undefined') {
                           // Ensure it's available globally
                           if (typeof window.MicVAD === 'undefined') {
                               window.MicVAD = MicVAD;
                           }
                           console.log('✅ MicVAD is available!');
                           resolve();
                       } else if (checks < 50) {
                           setTimeout(checkForMicVAD, 100);
                       } else {
                           console.error('❌ MicVAD not available after 5 seconds');
                           reject(new Error('MicVAD not available'));
                       }
                   };
                   
                   checkForMicVAD();
               };
               
               script.onerror = () => {
                   console.error('Failed to load VAD script');
                   reject(new Error('Failed to load VAD script'));
               };
               
               document.head.appendChild(script);
           });
       }

       // Load everything in sequence
       window.addEventListener('DOMContentLoaded', async () => {
           console.log('DOM loaded, loading VAD library...');
           
           try {
               await loadVADLibrary();
               console.log('VAD library ready, loading main script...');
               
               const mainScript = document.createElement('script');
               mainScript.src = "{{ url_for('static', filename='js/main.js') }}";
               mainScript.onload = () => console.log('Main script loaded successfully');
               mainScript.onerror = () => console.error('Failed to load main script');
               document.body.appendChild(mainScript);
               
           } catch (error) {
               console.error('Error loading VAD library:', error);
           }
       });
   </script>

</body>
</html> 