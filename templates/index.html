<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Conversation App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container with-sidebar">
        <!-- Sidebar for Conversation History -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Conversation History</h2>
                <div class="sidebar-actions">
                    <button id="newConversationBtn" class="action-button" title="New Conversation">
                        <span class="action-icon">+</span>
                    </button>
                    <button id="refreshConversationsBtn" class="action-button" title="Refresh conversations">
                        <span class="action-icon">‚Üª</span>
                    </button>
                </div>
            </div>
            <div class="conversation-list" id="conversationList">
                <!-- Conversation history will be loaded here -->
                <div class="empty-state">No saved conversations</div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <header>
                <h1>Can you guess what's wrong with me?</h1>
                <div class="simulation-selector">
                    <label for="simulationSelect">Select Patient Simulation (Optional):</label>
                    <select id="simulationSelect">
                        <option value="">No simulation</option>
                        <option value="__custom__">Create Custom Patient</option>
                    </select>
                </div>
                
                <!-- Custom Patient Form (initially hidden) -->
                <div id="customPatientForm" class="custom-patient-form" style="display: none;">
                    <!-- Form Wizard Header -->
                    <div class="wizard-header">
                        <h3>üè• Generate AI Patient Case</h3>
                        <p class="wizard-subtitle">Create a realistic medical scenario for training and simulation</p>
                        
                        <!-- Progress Indicator -->
                        <div class="wizard-progress">
                            <div class="wizard-step active" data-step="1">
                                <div class="step-indicator">
                                    <span class="step-number">1</span>
                                    <div class="step-line"></div>
                                </div>
                                <span class="step-title">Templates</span>
                            </div>
                            <div class="wizard-step" data-step="2">
                                <div class="step-indicator">
                                    <span class="step-number">2</span>
                                    <div class="step-line"></div>
                                </div>
                                <span class="step-title">Patient Info</span>
                            </div>
                            <div class="wizard-step" data-step="3">
                                <div class="step-indicator">
                                    <span class="step-number">3</span>
                                    <div class="step-line"></div>
                                </div>
                                <span class="step-title">Medical Case</span>
                            </div>
                            <div class="wizard-step" data-step="4">
                                <div class="step-indicator">
                                    <span class="step-number">4</span>
                                </div>
                                <span class="step-title">Review</span>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Loading State -->
                    <div id="aiGenerationLoading" class="loading-state enhanced" style="display: none;">
                        <div class="loading-content">
                            <div class="loading-animation">
                                <div class="pulse-rings">
                                    <div class="pulse-ring"></div>
                                    <div class="pulse-ring"></div>
                                    <div class="pulse-ring"></div>
                                </div>
                                <div class="medical-icon">üß¨</div>
                            </div>
                            <h4>Generating Your AI Patient Case</h4>
                            <div class="generation-steps">
                                <div class="generation-step" id="step-analyzing">
                                    <div class="step-icon">üîç</div>
                                    <span>Analyzing medical parameters...</span>
                                    <div class="step-status"></div>
                                </div>
                                <div class="generation-step" id="step-creating">
                                    <div class="step-icon">üß†</div>
                                    <span>Creating patient profile...</span>
                                    <div class="step-status"></div>
                                </div>
                                <div class="generation-step" id="step-symptoms">
                                    <div class="step-icon">üìã</div>
                                    <span>Developing symptom presentation...</span>
                                    <div class="step-status"></div>
                                </div>
                                <div class="generation-step" id="step-finalizing">
                                    <div class="step-icon">‚ú®</div>
                                    <span>Finalizing case scenario...</span>
                                    <div class="step-status"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Content Container -->
                    <div class="wizard-content">
                        <form id="customPatientFormFields">
                            
                            <!-- Step 1: Quick Start Templates -->
                            <div class="wizard-panel active" data-panel="1">
                                <div class="panel-header">
                                    <h4>üöÄ Quick Start Templates</h4>
                                    <p>Choose a template to get started quickly, or skip to create from scratch</p>
                                </div>
                                
                                <div class="templates-grid">
                                    <div class="template-card" data-template="emergency-cardiac">
                                        <div class="template-icon">ü´Ä</div>
                                        <h5>Emergency: Cardiac Event</h5>
                                        <p>Chest pain, shortness of breath, typical emergency presentation</p>
                                        <div class="template-tags">
                                            <span class="tag severity-high">High Severity</span>
                                            <span class="tag specialty-cardiology">Cardiology</span>
                                        </div>
                                    </div>
                                    
                                    <div class="template-card" data-template="routine-headache">
                                        <div class="template-icon">üß†</div>
                                        <h5>Routine: Neurological</h5>
                                        <p>Persistent headaches, routine office visit scenario</p>
                                        <div class="template-tags">
                                            <span class="tag severity-moderate">Moderate</span>
                                            <span class="tag specialty-neurology">Neurology</span>
                                        </div>
                                    </div>
                                    
                                    <div class="template-card" data-template="respiratory-infection">
                                        <div class="template-icon">ü´Å</div>
                                        <h5>Respiratory: Infection</h5>
                                        <p>Cough, fever, breathing difficulties</p>
                                        <div class="template-tags">
                                            <span class="tag severity-moderate">Moderate</span>
                                            <span class="tag specialty-pulmonology">Pulmonology</span>
                                        </div>
                                    </div>
                                    
                                    <div class="template-card" data-template="gi-symptoms">
                                        <div class="template-icon">ü´Ñ</div>
                                        <h5>GI: Abdominal Pain</h5>
                                        <p>Abdominal pain, nausea, digestive issues</p>
                                        <div class="template-tags">
                                            <span class="tag severity-moderate">Moderate</span>
                                            <span class="tag specialty-gastroenterology">GI</span>
                                        </div>
                                    </div>
                                    
                                    <div class="template-card custom-template" data-template="custom">
                                        <div class="template-icon">‚öôÔ∏è</div>
                                        <h5>Custom Case</h5>
                                        <p>Build your own case from scratch with full customization</p>
                                        <div class="template-tags">
                                            <span class="tag custom">Custom</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="template-selection-info" id="templateSelectionInfo" style="display: none;">
                                    <div class="selection-summary">
                                        <h6>Selected Template:</h6>
                                        <div id="selectedTemplateDetails"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 2: Patient Demographics -->
                            <div class="wizard-panel" data-panel="2">
                                <div class="panel-header">
                                    <h4>üë§ Patient Demographics</h4>
                                    <p>Define the basic characteristics of your virtual patient</p>
                                </div>
                                
                                <div class="form-grid">
                                    <div class="form-card">
                                        <h5>Basic Information</h5>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="patientAge">Age <span class="required">*</span></label>
                                                <div class="input-with-help">
                                                    <input 
                                                        type="number" 
                                                        id="patientAge" 
                                                        name="age" 
                                                        min="1" 
                                                        max="120" 
                                                        required 
                                                        placeholder="e.g., 45"
                                                        class="form-control enhanced"
                                                    >
                                                    <div class="field-help" data-help="age">
                                                        <i class="help-icon">‚ÑπÔ∏è</i>
                                                        <div class="help-tooltip">
                                                            Patient age affects disease likelihood and presentation patterns
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="error-message enhanced" id="ageError"></div>
                                            </div>
                                            
                                            <div class="form-group">
                                                <label for="patientGender">Gender <span class="required">*</span></label>
                                                <select id="patientGender" name="gender" required class="form-control enhanced">
                                                    <option value="">Select gender</option>
                                                    <option value="Male">Male</option>
                                                    <option value="Female">Female</option>
                                                    <option value="Non-binary">Non-binary</option>
                                                    <option value="Other">Other</option>
                                                </select>
                                                <div class="error-message enhanced" id="genderError"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="patientOccupation">Occupation <span class="required">*</span></label>
                                            <div class="autocomplete-wrapper">
                                                <input 
                                                    type="text" 
                                                    id="patientOccupation" 
                                                    name="occupation" 
                                                    required 
                                                    placeholder="Start typing or select from suggestions..."
                                                    class="form-control enhanced"
                                                    list="occupationSuggestions"
                                                    autocomplete="off"
                                                >
                                                <datalist id="occupationSuggestions">
                                                    <option value="Teacher">
                                                    <option value="Nurse">
                                                    <option value="Engineer">
                                                    <option value="Office Manager">
                                                    <option value="Student">
                                                    <option value="Retired">
                                                    <option value="Doctor">
                                                    <option value="Sales Representative">
                                                    <option value="Accountant">
                                                    <option value="Construction Worker">
                                                    <option value="Chef">
                                                    <option value="Police Officer">
                                                    <option value="Firefighter">
                                                    <option value="Lawyer">
                                                    <option value="Mechanic">
                                                </datalist>
                                                <div class="suggestion-pills" id="occupationPills"></div>
                                            </div>
                                            <div class="error-message enhanced" id="occupationError"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-card">
                                        <h5>Medical Background</h5>
                                        <div class="form-group">
                                            <label for="patientMedicalHistory">Medical History</label>
                                            <textarea 
                                                id="patientMedicalHistory" 
                                                name="medical_history" 
                                                rows="3" 
                                                placeholder="e.g., Hypertension controlled with medication, No significant medical history, Previous surgery..."
                                                class="form-control enhanced"
                                            ></textarea>
                                            <div class="field-note">Optional: Existing conditions that might influence the case</div>
                                            <div class="error-message enhanced" id="medicalHistoryError"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 3: Medical Case Parameters -->
                            <div class="wizard-panel" data-panel="3">
                                <div class="panel-header">
                                    <h4>üè• Medical Case Parameters</h4>
                                    <p>Define the clinical presentation and complexity</p>
                                </div>
                                
                                <div class="form-grid">
                                    <div class="form-card">
                                        <h5>Clinical Specialty</h5>
                                        <div class="form-group">
                                            <label for="medicalSpecialty">Medical Specialty <span class="required">*</span></label>
                                            <select id="medicalSpecialty" name="specialty" required class="form-control enhanced">
                                                <option value="">Choose medical field...</option>
                                                <!-- Options will be populated dynamically -->
                                            </select>
                                            <div class="specialty-description enhanced" id="specialtyDescription"></div>
                                            <div class="error-message enhanced" id="specialtyError"></div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="symptomSeverity">Case Complexity <span class="required">*</span></label>
                                            <div class="severity-selector">
                                                <div class="severity-option" data-severity="mild">
                                                    <input type="radio" id="severity-mild" name="severity" value="mild" required>
                                                    <label for="severity-mild">
                                                        <div class="severity-icon">üü¢</div>
                                                        <div class="severity-info">
                                                            <strong>Mild</strong>
                                                            <small>Routine case, clear presentation</small>
                                                        </div>
                                                    </label>
                                                </div>
                                                <div class="severity-option" data-severity="moderate">
                                                    <input type="radio" id="severity-moderate" name="severity" value="moderate" required>
                                                    <label for="severity-moderate">
                                                        <div class="severity-icon">üü°</div>
                                                        <div class="severity-info">
                                                            <strong>Moderate</strong>
                                                            <small>Some diagnostic challenge</small>
                                                        </div>
                                                    </label>
                                                </div>
                                                <div class="severity-option" data-severity="severe">
                                                    <input type="radio" id="severity-severe" name="severity" value="severe" required>
                                                    <label for="severity-severe">
                                                        <div class="severity-icon">üî¥</div>
                                                        <div class="severity-info">
                                                            <strong>Severe</strong>
                                                            <small>Complex, emergency scenario</small>
                                                        </div>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="error-message enhanced" id="severityError"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-card">
                                        <h5>Presenting Symptoms</h5>
                                        <div class="form-group">
                                            <label>Select Symptoms <span class="required">*</span></label>
                                            <div class="symptoms-info">
                                                <p id="symptomsInstructions">Select a specialty above to see available symptoms</p>
                                            </div>
                                            <div id="symptomsContainer" class="symptoms-container enhanced" style="display: none;">
                                                <!-- Dynamic symptom selection will be populated here -->
                                            </div>
                                            <div class="error-message enhanced" id="symptomsError"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 4: Review & Generate -->
                            <div class="wizard-panel" data-panel="4">
                                <div class="panel-header">
                                    <h4>üìã Review & Generate</h4>
                                    <p>Review your case parameters and generate the AI patient</p>
                                </div>
                                
                                <div class="review-container">
                                    <div class="case-preview-card">
                                        <h5>üìä Case Summary</h5>
                                        <div class="preview-grid">
                                            <div class="preview-section">
                                                <h6>Patient Profile</h6>
                                                <div class="preview-items">
                                                    <div class="preview-item">
                                                        <span class="label">Age:</span>
                                                        <span class="value" id="previewAge">-</span>
                                                    </div>
                                                    <div class="preview-item">
                                                        <span class="label">Gender:</span>
                                                        <span class="value" id="previewGender">-</span>
                                                    </div>
                                                    <div class="preview-item">
                                                        <span class="label">Occupation:</span>
                                                        <span class="value" id="previewOccupation">-</span>
                                                    </div>
                                                    <div class="preview-item" id="previewMedicalHistoryItem" style="display: none;">
                                                        <span class="label">Medical History:</span>
                                                        <span class="value" id="previewMedicalHistory">-</span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="preview-section">
                                                <h6>Clinical Parameters</h6>
                                                <div class="preview-items">
                                                    <div class="preview-item">
                                                        <span class="label">Specialty:</span>
                                                        <span class="value" id="previewSpecialty">-</span>
                                                    </div>
                                                    <div class="preview-item">
                                                        <span class="label">Complexity:</span>
                                                        <span class="value" id="previewSeverity">-</span>
                                                    </div>
                                                    <div class="preview-item">
                                                        <span class="label">Symptoms:</span>
                                                        <div class="symptoms-preview" id="previewSymptoms">
                                                            <span class="no-symptoms">None selected</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="generation-info">
                                            <div class="info-card">
                                                <div class="info-icon">‚è±Ô∏è</div>
                                                <div class="info-content">
                                                    <strong>Generation Time:</strong>
                                                    <small>Typically 10-30 seconds</small>
                                                </div>
                                            </div>
                                            <div class="info-card">
                                                <div class="info-icon">üéØ</div>
                                                <div class="info-content">
                                                    <strong>AI Features:</strong>
                                                    <small>Realistic symptoms, medical history, and responses</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Enhanced Navigation -->
                            <div class="wizard-navigation">
                                <button type="button" id="wizardPrevBtn" class="btn btn-secondary" style="display: none;">
                                    <span class="btn-icon">‚Üê</span>
                                    Previous
                                </button>
                                
                                <div class="nav-center">
                                    <button type="button" id="cancelCustomPatient" class="btn btn-ghost">
                                        Cancel
                                    </button>
                                </div>
                                
                                <button type="button" id="wizardNextBtn" class="btn btn-primary">
                                    Next
                                    <span class="btn-icon">‚Üí</span>
                                </button>
                                
                                <button type="submit" id="createCustomPatient" class="btn btn-success" style="display: none;">
                                    <span class="btn-icon">‚ú®</span>
                                    <span class="button-text">Generate Patient Case</span>
                                    <span class="button-spinner" style="display: none;">üîÑ</span>
                                </button>
                            </div>
                            
                        </form>
                        
                        <!-- Enhanced Validation Summary -->
                        <div id="formValidationSummary" class="validation-summary enhanced" style="display: none;">
                            <div class="validation-header">
                                <span class="validation-icon">‚ö†Ô∏è</span>
                                <h5>Please review the following:</h5>
                            </div>
                            <ul id="validationErrorsList" class="validation-list"></ul>
                        </div>
                    </div>
                </div>
                
                <div class="voice-selector">
                    <label for="voiceSelect">Select Voice:</label>
                    <select id="voiceSelect">
                        <option value="Fritz-PlayAI">Fritz (Default)</option>
                        <option value="Cillian-PlayAI">Cillian</option>
                        <option value="Arista-PlayAI">Arista</option>
                        <option value="Celeste-PlayAI">Celeste</option>
                        <option value="Mamaw-PlayAI">Bill</option>
                        <option value="Cheyenne-PlayAI">Emily</option>
                    </select>
                </div>
                <p class="status" id="status">Ready</p>
            </header>
            
            <main>
                <div class="conversation" id="conversation">
                    <!-- Conversation messages will be displayed here -->
                </div>
                
                <!-- ‚ù∑ NEW  insert in exactly the same place -->
                <div class="controls">
                    <button id="autoListenBtn" class="record-button">
                        <span class="record-icon"></span>
                        Auto Listen
                    </button>
                </div>

            </main>
            
            <footer>
                <p>Powered by Groq API</p>
            </footer>
        </div>

        <!-- NEW: Diagnosis Panel -->
        <aside class="diagnosis-panel" id="diagnosisPanel" style="display: none;">
            <div class="diagnosis-header">
                <h3>Submit Diagnosis</h3>
                <div class="diagnosis-instructions">
                    <p>What is your diagnosis for this patient?</p>
                </div>
            </div>
            
            <div class="diagnosis-content">
                <div class="form-group">
                    <label for="diagnosisInput">Your Diagnosis:</label>
                    <textarea 
                        id="diagnosisInput" 
                        placeholder="e.g., Acute appendicitis, Migraine headache, Pneumonia..."
                        rows="3"
                        class="diagnosis-textarea"
                    ></textarea>
                </div>
                
                <div class="diagnosis-actions">
                    <button id="submitDiagnosisBtn" class="btn btn-primary diagnosis-submit">
                        <span class="button-text">Submit Diagnosis</span>
                        <span class="button-spinner" style="display: none;">üîÑ</span>
                    </button>
                    <button id="clearDiagnosisBtn" class="btn btn-secondary">
                        Clear
                    </button>
                </div>
                
                <!-- Feedback Section -->
                <div id="diagnosisFeedback" class="diagnosis-feedback" style="display: none;">
                    <div class="feedback-header">
                        <h4>Diagnosis Result</h4>
                    </div>
                    <div class="feedback-content">
                        <div id="feedbackMessage" class="feedback-message"></div>
                        <div id="feedbackDetails" class="feedback-details"></div>
                    </div>
                    <div class="feedback-actions">
                        <button id="tryAgainBtn" class="btn btn-secondary">Try Again</button>
                        <button id="showAnswerBtn" class="btn btn-link">Show Correct Answer</button>
                    </div>
                </div>
                
                <!-- Patient Details Summary -->
                <div class="diagnosis-patient-details" id="diagnosisPatientDetails">
                    <h4>Patient Information</h4>
                    <div id="patientSummary">
                        <p>No patient simulation active</p>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Floating Diagnosis Toggle Button -->
    <button id="diagnosisToggle" class="diagnosis-toggle">
        Submit Diagnosis
    </button>

    <!-- Add logging div for debugging -->
    <div id="vadLogs" style="display: none; position: fixed; bottom: 0; right: 0; max-height: 300px; overflow-y: auto; background: rgba(0,0,0,0.8); color: white; padding: 10px; font-family: monospace; font-size: 12px;">
        <div style="margin-bottom: 10px;">
            <button onclick="document.getElementById('vadLogContent').innerHTML = ''">Clear Logs</button>
            <button onclick="document.getElementById('vadLogs').style.display = 'none'">Hide</button>
        </div>
        <div id="vadLogContent"></div>
    </div>

    <!-- Load dependencies with detailed logging -->
    <script>
        // Initialize logging system
        const vadLogger = {
            log: function(step, message, type = 'info') {
                const timestamp = new Date().toISOString().split('T')[1];
                const logElement = document.getElementById('vadLogContent');
                const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'white';
                
                // Console logging
                console.log(`[VAD ${step}] ${message}`);
                
                // UI logging
                if (logElement) {
                    logElement.innerHTML = `<div style="color: ${color};">[${timestamp}] [${step}] ${message}</div>` + logElement.innerHTML;
                }
            },
            error: function(step, message) {
                this.log(step, message, 'error');
            },
            success: function(step, message) {
                this.log(step, message, 'success');
            }
        };

        // Show logs button in header
        document.addEventListener('DOMContentLoaded', () => {
            const header = document.querySelector('header');
            if (header) {
                const showLogsBtn = document.createElement('button');
                showLogsBtn.textContent = 'Show VAD Logs';
                showLogsBtn.onclick = () => document.getElementById('vadLogs').style.display = 'block';
                header.appendChild(showLogsBtn);
            }
        });
    </script>

    <!-- onnxruntime ‚Äì must be first so it defines global `ort` -->
    <script
    src="{{ url_for('static', filename='vad-model/ort.min.js') }}"
    onload="vadLogger.success('DEPS', 'ONNX Runtime loaded successfully')"
    onerror="vadLogger.error('DEPS', 'Failed to load ONNX Runtime')">
    </script>

    <!-- VAD wrapper ‚Äì exposes global `vad` -->
    <script
    src="{{ url_for('static', filename='vad-model/bundle.min.js') }}"
    onload="vadLogger.success('DEPS', 'VAD bundle loaded successfully')"
    onerror="vadLogger.error('DEPS', 'Failed to load VAD bundle')">
    </script>

    <!-- ‚≠ê your application logic (needs `vad` to exist) -->
    <script
    src="{{ url_for('static', filename='js/main.js') }}"
    onload="vadLogger.success('DEPS', 'Main script loaded successfully')"
    onerror="vadLogger.error('DEPS', 'Failed to load main script')">
    </script>

    <!-- Medical Knowledge and Form Management Script -->
    <script>
        // Medical knowledge data - will be populated from backend
        let medicalKnowledge = {
            specialties: {},
            all_symptoms: {}
        };

        // Form state management
        const formState = {
            selectedSpecialty: null,
            selectedSymptoms: [],
            isLoading: false
        };

        // Initialize medical knowledge on page load
        async function initializeMedicalKnowledge() {
            try {
                const response = await fetch('/api/medical-knowledge');
                const data = await response.json();
                
                if (data.status === 'success') {
                    medicalKnowledge = data;
                    populateSpecialtySelector();
                    console.log('Medical knowledge loaded:', medicalKnowledge);
                } else {
                    console.error('Failed to load medical knowledge:', data.message);
                    showFormError('Failed to load medical specialties. Please refresh the page.');
                }
            } catch (error) {
                console.error('Error loading medical knowledge:', error);
                showFormError('Failed to load medical specialties. Please check your connection and refresh.');
            }
        }

        // Populate specialty selector with options
        function populateSpecialtySelector() {
            const specialtySelect = document.getElementById('medicalSpecialty');
            if (!specialtySelect) return;

            // Clear existing options (except the first one)
            while (specialtySelect.options.length > 1) {
                specialtySelect.removeChild(specialtySelect.lastChild);
            }

            // Add specialty options
            Object.entries(medicalKnowledge.specialties).forEach(([key, specialty]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = specialty.name;
                option.dataset.description = specialty.description;
                specialtySelect.appendChild(option);
            });
        }

        // Handle specialty selection change
        function handleSpecialtyChange(event) {
            const selectedKey = event.target.value;
            const descriptionDiv = document.getElementById('specialtyDescription');
            const symptomsContainer = document.getElementById('symptomsContainer');
            const symptomsInstructions = document.getElementById('symptomsInstructions');

            formState.selectedSpecialty = selectedKey;
            formState.selectedSymptoms = []; // Reset selected symptoms

            if (selectedKey && medicalKnowledge.specialties[selectedKey]) {
                const specialty = medicalKnowledge.specialties[selectedKey];
                
                // Show specialty description
                descriptionDiv.textContent = specialty.description;
                descriptionDiv.style.display = 'block';
                
                // Populate symptoms for this specialty
                populateSymptoms(specialty.symptoms);
                
                // Show symptoms container
                symptomsInstructions.style.display = 'none';
                symptomsContainer.style.display = 'block';
            } else {
                // Clear everything
                descriptionDiv.textContent = '';
                descriptionDiv.style.display = 'none';
                symptomsContainer.style.display = 'none';
                symptomsInstructions.style.display = 'block';
                symptomsInstructions.textContent = 'Select a specialty above to see available symptoms';
            }

            // Clear any previous validation errors
            clearFieldError('specialtyError');
            clearFieldError('symptomsError');
        }

        // Populate symptoms checkboxes for selected specialty
        function populateSymptoms(symptomKeys) {
            const container = document.getElementById('symptomsContainer');
            if (!container) return;

            // Clear existing checkboxes
            container.innerHTML = '';

            // Create symptom checkboxes
            symptomKeys.forEach(symptomKey => {
                const symptomName = medicalKnowledge.all_symptoms[symptomKey] || symptomKey;
                
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'symptom-checkbox';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `symptom_${symptomKey}`;
                checkbox.value = symptomKey;
                checkbox.addEventListener('change', handleSymptomChange);
                
                const label = document.createElement('label');
                label.htmlFor = `symptom_${symptomKey}`;
                label.textContent = symptomName;
                
                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                container.appendChild(checkboxDiv);
            });

            // Add instructions
            if (symptomKeys.length > 0) {
                const instructionsDiv = document.createElement('div');
                instructionsDiv.className = 'symptoms-instructions';
                instructionsDiv.innerHTML = '<small>Select one or more symptoms that the patient should present with:</small>';
                container.insertBefore(instructionsDiv, container.firstChild);
            }
        }

        // Handle symptom checkbox changes
        function handleSymptomChange(event) {
            const symptomKey = event.target.value;
            
            if (event.target.checked) {
                if (!formState.selectedSymptoms.includes(symptomKey)) {
                    formState.selectedSymptoms.push(symptomKey);
                }
            } else {
                formState.selectedSymptoms = formState.selectedSymptoms.filter(s => s !== symptomKey);
            }

            console.log('Selected symptoms:', formState.selectedSymptoms);
            
            // Clear symptoms validation error if at least one selected
            if (formState.selectedSymptoms.length > 0) {
                clearFieldError('symptomsError');
            }
        }

        // Form validation functions
        function validateForm() {
            let isValid = true;
            const errors = [];

            // Clear previous validation
            clearAllErrors();

            // Age validation
            const age = document.getElementById('patientAge').value;
            if (!age || age < 1 || age > 120) {
                showFieldError('ageError', 'Age must be between 1 and 120');
                errors.push('Valid age is required');
                isValid = false;
            }

            // Gender validation
            const gender = document.getElementById('patientGender').value;
            if (!gender) {
                showFieldError('genderError', 'Gender selection is required');
                errors.push('Gender selection is required');
                isValid = false;
            }

            // Occupation validation
            const occupation = document.getElementById('patientOccupation').value.trim();
            if (!occupation) {
                showFieldError('occupationError', 'Occupation is required');
                errors.push('Occupation is required');
                isValid = false;
            }

            // Specialty validation
            if (!formState.selectedSpecialty) {
                showFieldError('specialtyError', 'Medical specialty selection is required');
                errors.push('Medical specialty selection is required');
                isValid = false;
            }

            // Symptoms validation
            if (formState.selectedSymptoms.length === 0) {
                showFieldError('symptomsError', 'At least one symptom must be selected');
                errors.push('At least one symptom must be selected');
                isValid = false;
            }

            // Severity validation
            const severity = document.getElementById('symptomSeverity').value;
            if (!severity) {
                showFieldError('severityError', 'Symptom severity selection is required');
                errors.push('Symptom severity selection is required');
                isValid = false;
            }

            // Show validation summary if there are errors
            if (!isValid) {
                showValidationSummary(errors);
            } else {
                hideValidationSummary();
            }

            return isValid;
        }

        // Validation helper functions
        function showFieldError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        function clearFieldError(elementId) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = '';
                errorElement.style.display = 'none';
            }
        }

        function clearAllErrors() {
            const errorElements = document.querySelectorAll('.error-message');
            errorElements.forEach(element => {
                element.textContent = '';
                element.style.display = 'none';
            });
        }

        function showValidationSummary(errors) {
            const summaryDiv = document.getElementById('formValidationSummary');
            const errorsList = document.getElementById('validationErrorsList');
            
            if (summaryDiv && errorsList) {
                errorsList.innerHTML = '';
                errors.forEach(error => {
                    const li = document.createElement('li');
                    li.textContent = error;
                    errorsList.appendChild(li);
                });
                summaryDiv.style.display = 'block';
                summaryDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function hideValidationSummary() {
            const summaryDiv = document.getElementById('formValidationSummary');
            if (summaryDiv) {
                summaryDiv.style.display = 'none';
            }
        }

        function showFormError(message) {
            const symptomsInstructions = document.getElementById('symptomsInstructions');
            if (symptomsInstructions) {
                symptomsInstructions.textContent = message;
                symptomsInstructions.style.color = 'red';
            }
        }

        // Loading state management
        function setLoadingState(isLoading) {
            formState.isLoading = isLoading;
            const loadingDiv = document.getElementById('aiGenerationLoading');
            const formFields = document.getElementById('customPatientFormFields');
            const submitButton = document.getElementById('createCustomPatient');
            const buttonText = submitButton?.querySelector('.button-text');
            const buttonSpinner = submitButton?.querySelector('.button-spinner');

            if (isLoading) {
                loadingDiv.style.display = 'block';
                formFields.style.opacity = '0.6';
                formFields.style.pointerEvents = 'none';
                if (submitButton) submitButton.disabled = true;
                if (buttonText) buttonText.style.display = 'none';
                if (buttonSpinner) buttonSpinner.style.display = 'inline';
            } else {
                loadingDiv.style.display = 'none';
                formFields.style.opacity = '1';
                formFields.style.pointerEvents = 'auto';
                if (submitButton) submitButton.disabled = false;
                if (buttonText) buttonText.style.display = 'inline';
                if (buttonSpinner) buttonSpinner.style.display = 'none';
            }
        }

        // Event listeners setup
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize medical knowledge
            initializeMedicalKnowledge();

            // Specialty selection change handler
            const specialtySelect = document.getElementById('medicalSpecialty');
            if (specialtySelect) {
                specialtySelect.addEventListener('change', handleSpecialtyChange);
            }

            // Form submission will be handled in main.js
            console.log('Medical form management initialized');
        });
    </script>

</body>
</html> 