<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Conversation App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container with-sidebar">
        <!-- Sidebar for Conversation History -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Conversation History</h2>
                <div class="sidebar-actions">
                    <button id="newConversationBtn" class="action-button" title="New Conversation">
                        <span class="action-icon">+</span>
                    </button>
                    <button id="refreshConversationsBtn" class="action-button" title="Refresh conversations">
                        <span class="action-icon">↻</span>
                    </button>
                </div>
            </div>
            <div class="conversation-list" id="conversationList">
                <!-- Conversation history will be loaded here -->
                <div class="empty-state">No saved conversations</div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <header>
                <h1>Can you guess what's wrong with me?</h1>
                <div class="simulation-selector">
                    <label for="simulationSelect">Select Patient Simulation (Optional):</label>
                    <select id="simulationSelect">
                        <option value="">No simulation</option>
                        <option value="__custom__">Create Custom Patient</option>
                        <option value="" disabled>Loading simulations...</option>
                    </select>
                </div>
                
                <!-- Custom Patient Form (initially hidden) -->
                <div id="customPatientForm" class="custom-patient-form" style="display: none;">
                    <h3>Create Custom Patient</h3>
                    <form id="customPatientFormFields">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="patientAge">Age <span class="required">*</span></label>
                                <input 
                                    type="number" 
                                    id="patientAge" 
                                    name="age" 
                                    min="1" 
                                    max="120" 
                                    required 
                                    placeholder="e.g., 45"
                                    class="form-control"
                                >
                                <div class="error-message" id="ageError"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="patientGender">Gender <span class="required">*</span></label>
                                <select id="patientGender" name="gender" required class="form-control">
                                    <option value="">Select gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Non-binary">Non-binary</option>
                                    <option value="Other">Other</option>
                                </select>
                                <div class="error-message" id="genderError"></div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="patientOccupation">Occupation <span class="required">*</span></label>
                                <input 
                                    type="text" 
                                    id="patientOccupation" 
                                    name="occupation" 
                                    required 
                                    placeholder="e.g., Office manager, Teacher, Retired"
                                    class="form-control"
                                >
                                <div class="error-message" id="occupationError"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="patientMedicalHistory">Medical History</label>
                            <textarea 
                                id="patientMedicalHistory" 
                                name="medical_history" 
                                rows="3" 
                                placeholder="e.g., Hypertension controlled with medication, No significant history"
                                class="form-control"
                            ></textarea>
                            <div class="error-message" id="medicalHistoryError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="patientIllness">Current Condition/Symptoms <span class="required">*</span></label>
                            <textarea 
                                id="patientIllness" 
                                name="illness" 
                                rows="3" 
                                required 
                                placeholder="e.g., Migraine, Chest pain, Persistent cough - describe the symptoms the patient should exhibit"
                                class="form-control"
                            ></textarea>
                            <div class="error-message" id="illnessError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="patientRecentExposure">Recent Events or Exposures</label>
                            <textarea 
                                id="patientRecentExposure" 
                                name="recent_exposure" 
                                rows="2" 
                                placeholder="e.g., Working long hours with poor lighting, Recent travel, Attended large gathering"
                                class="form-control"
                            ></textarea>
                            <div class="error-message" id="recentExposureError"></div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" id="cancelCustomPatient" class="btn btn-secondary">Cancel</button>
                            <button type="submit" id="createCustomPatient" class="btn btn-primary">Create Patient</button>
                        </div>
                    </form>
                </div>
                
                <div class="voice-selector">
                    <label for="voiceSelect">Select Voice:</label>
                    <select id="voiceSelect">
                        <option value="Fritz-PlayAI">Fritz (Default)</option>
                        <option value="Cillian-PlayAI">Cillian</option>
                        <option value="Arista-PlayAI">Arista</option>
                        <option value="Celeste-PlayAI">Celeste</option>
                        <option value="Mamaw-PlayAI">Bill</option>
                        <option value="Cheyenne-PlayAI">Emily</option>
                    </select>
                </div>
                <p class="status" id="status">Ready</p>
            </header>
            
            <main>
                <div class="conversation" id="conversation">
                    <!-- Conversation messages will be displayed here -->
                </div>
                
                <!-- ❷ NEW  insert in exactly the same place -->
                <div class="controls">
                    <button id="autoListenBtn" class="record-button">
                        <span class="record-icon"></span>
                        Auto Listen
                    </button>
                </div>

            </main>
            
            <footer>
                <p>Powered by Groq API</p>
            </footer>
        </div>
    </div>
    
    <!-- Add logging div for debugging -->
    <div id="vadLogs" style="display: none; position: fixed; bottom: 0; right: 0; max-height: 300px; overflow-y: auto; background: rgba(0,0,0,0.8); color: white; padding: 10px; font-family: monospace; font-size: 12px;">
        <div style="margin-bottom: 10px;">
            <button onclick="document.getElementById('vadLogContent').innerHTML = ''">Clear Logs</button>
            <button onclick="document.getElementById('vadLogs').style.display = 'none'">Hide</button>
        </div>
        <div id="vadLogContent"></div>
    </div>

    <!-- Load dependencies with detailed logging -->
    <script>
        // Initialize logging system
        const vadLogger = {
            log: function(step, message, type = 'info') {
                const timestamp = new Date().toISOString().split('T')[1];
                const logElement = document.getElementById('vadLogContent');
                const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'white';
                
                // Console logging
                console.log(`[VAD ${step}] ${message}`);
                
                // UI logging
                if (logElement) {
                    logElement.innerHTML = `<div style="color: ${color};">[${timestamp}] [${step}] ${message}</div>` + logElement.innerHTML;
                }
            },
            error: function(step, message) {
                this.log(step, message, 'error');
            },
            success: function(step, message) {
                this.log(step, message, 'success');
            }
        };

        // Show logs button in header
        document.addEventListener('DOMContentLoaded', () => {
            const header = document.querySelector('header');
            if (header) {
                const showLogsBtn = document.createElement('button');
                showLogsBtn.textContent = 'Show VAD Logs';
                showLogsBtn.onclick = () => document.getElementById('vadLogs').style.display = 'block';
                header.appendChild(showLogsBtn);
            }
        });
    </script>

    <!-- onnxruntime – must be first so it defines global `ort` -->
    <script
    src="{{ url_for('static', filename='vad-model/ort.min.js') }}"
    onload="vadLogger.success('DEPS', 'ONNX Runtime loaded successfully')"
    onerror="vadLogger.error('DEPS', 'Failed to load ONNX Runtime')">
    </script>

    <!-- VAD wrapper – exposes global `vad` -->
    <script
    src="{{ url_for('static', filename='vad-model/bundle.min.js') }}"
    onload="vadLogger.success('DEPS', 'VAD bundle loaded successfully')"
    onerror="vadLogger.error('DEPS', 'Failed to load VAD bundle')">
    </script>

    <!-- ⭐ your application logic (needs `vad` to exist) -->
    <script
    src="{{ url_for('static', filename='js/main.js') }}"
    onload="vadLogger.success('DEPS', 'Main script loaded successfully')"
    onerror="vadLogger.error('DEPS', 'Failed to load main script')">
    </script>


</body>
</html> 