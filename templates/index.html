<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Conversation App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container with-sidebar">
        <!-- Sidebar for Conversation History -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Conversation History</h2>
                <div class="sidebar-actions">
                    <button id="newConversationBtn" class="action-button" title="New Conversation">
                        <span class="action-icon">+</span>
                    </button>
                    <button id="refreshConversationsBtn" class="action-button" title="Refresh conversations">
                        <span class="action-icon">↻</span>
                    </button>
                </div>
            </div>
            <div class="conversation-list" id="conversationList">
                <!-- Conversation history will be loaded here -->
                <div class="empty-state">No saved conversations</div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <header>
                <h1>Can you guess what's wrong with me?</h1>
                <div class="simulation-selector">
                    <label for="simulationSelect">Select Patient Simulation (Optional):</label>
                    <select id="simulationSelect">
                        <option value="">No simulation</option>
                        <option value="" disabled>Loading simulations...</option>
                    </select>
                </div>
                <div class="voice-selector">
                    <label for="voiceSelect">Select Voice:</label>
                    <select id="voiceSelect">
                        <option value="Fritz-PlayAI">Fritz (Default)</option>
                        <option value="Cillian-PlayAI">Cillian</option>
                        <option value="Arista-PlayAI">Arista</option>
                        <option value="Celeste-PlayAI">Celeste</option>
                        <option value="Mamaw-PlayAI">Bill</option>
                        <option value="Cheyenne-PlayAI">Emily</option>
                    </select>
                </div>
                <p class="status" id="status">Ready</p>
            </header>
            
            <main>
                <div class="conversation" id="conversation">
                    <!-- Conversation messages will be displayed here -->
                </div>
                
                <!-- ❷ NEW  insert in exactly the same place -->
                <div class="controls">
                    <button id="autoListenBtn" class="record-button">
                        <span class="record-icon"></span>
                        Auto Listen
                    </button>
                </div>

            </main>
            
            <footer>
                <p>Powered by Groq API</p>
            </footer>
        </div>
    </div>
    
    <!-- Load ONNX Runtime first -->
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>

    <!-- Single consolidated script for loading -->
    <script>
        // Function to check what's available on window
        function debugWindowObjects() {
            console.log('=== WINDOW OBJECT DEBUGGING ===');
            console.log('ONNX Runtime (ort):', typeof ort !== 'undefined');
            console.log('MicVAD:', typeof MicVAD !== 'undefined');
            console.log('window.MicVAD:', typeof window.MicVAD !== 'undefined');
            console.log('=== END DEBUGGING ===');
        }

        // Load VAD library with Promise-based approach
        function loadVADLibrary() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.22/dist/bundle.min.js';
                
                script.onload = () => {
                    console.log('VAD script loaded, checking for MicVAD...');
                    
                    // Give a small delay for the library to initialize
                    setTimeout(() => {
                        // Check if MicVAD is available
                        if (typeof window.MicVAD !== 'undefined' || typeof MicVAD !== 'undefined') {
                            // Ensure it's available globally
                            if (typeof window.MicVAD === 'undefined' && typeof MicVAD !== 'undefined') {
                                window.MicVAD = MicVAD;
                            }
                            console.log('✅ MicVAD is available!');
                            resolve();
                        } else {
                            // Try importing as a module
                            import('https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.22/dist/index.js')
                                .then(module => {
                                    window.MicVAD = module.MicVAD;
                                    console.log('✅ MicVAD loaded via import');
                                    resolve();
                                })
                                .catch(error => {
                                    console.error('Failed to import VAD module:', error);
                                    reject(error);
                                });
                        }
                    }, 500); // Give it half a second to initialize
                };
                
                script.onerror = (error) => {
                    console.error('Failed to load VAD script:', error);
                    reject(error);
                };
                
                document.head.appendChild(script);
            });
        }

        // Main initialization function
        async function initializeApp() {
            try {
                console.log('Starting app initialization...');
                
                // First, load and initialize VAD
                await loadVADLibrary();
                console.log('VAD library initialized successfully');
                
                // Verify MicVAD is available
                debugWindowObjects();
                
                if (!window.MicVAD) {
                    throw new Error('MicVAD not available after initialization');
                }
                
                // Now load the main script
                const mainScript = document.createElement('script');
                mainScript.src = "{{ url_for('static', filename='js/main.js') }}";
                
                // Wait for main script to load
                await new Promise((resolve, reject) => {
                    mainScript.onload = resolve;
                    mainScript.onerror = reject;
                    document.body.appendChild(mainScript);
                });
                
                console.log('Main script loaded successfully');
                
            } catch (error) {
                console.error('Error during app initialization:', error);
            }
        }

        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html> 