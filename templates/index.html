<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Conversation App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container with-sidebar">
        <!-- Sidebar for Conversation History -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Conversation History</h2>
                <div class="sidebar-actions">
                    <button id="newConversationBtn" class="action-button" title="New Conversation">
                        <span class="action-icon">+</span>
                    </button>
                    <button id="refreshConversationsBtn" class="action-button" title="Refresh conversations">
                        <span class="action-icon">↻</span>
                    </button>
                </div>
            </div>
            <div class="conversation-list" id="conversationList">
                <!-- Conversation history will be loaded here -->
                <div class="empty-state">No saved conversations</div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <header>
                <h1>Can you guess what's wrong with me?</h1>
                <div class="simulation-selector">
                    <label for="simulationSelect">Select Patient Simulation (Optional):</label>
                    <select id="simulationSelect">
                        <option value="">No simulation</option>
                        <option value="" disabled>Loading simulations...</option>
                    </select>
                </div>
                <div class="voice-selector">
                    <label for="voiceSelect">Select Voice:</label>
                    <select id="voiceSelect">
                        <option value="Fritz-PlayAI">Fritz (Default)</option>
                        <option value="Cillian-PlayAI">Cillian</option>
                        <option value="Arista-PlayAI">Arista</option>
                        <option value="Celeste-PlayAI">Celeste</option>
                        <option value="Mamaw-PlayAI">Bill</option>
                        <option value="Cheyenne-PlayAI">Emily</option>
                    </select>
                </div>
                <p class="status" id="status">Ready</p>
            </header>
            
            <main>
                <div class="conversation" id="conversation">
                    <!-- Conversation messages will be displayed here -->
                </div>
                
                <!-- ❷ NEW  insert in exactly the same place -->
                <div class="controls">
                    <button id="autoListenBtn" class="record-button">
                        <span class="record-icon"></span>
                        Auto Listen
                    </button>
                </div>

            </main>
            
            <footer>
                <p>Powered by Groq API</p>
            </footer>
        </div>
    </div>
    
    <!-- Load ONNX Runtime first -->
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>

    <!-- Single consolidated script for loading -->
    <script>
        // Function to check what's available on window
        function debugWindowObjects() {
            console.log('=== WINDOW OBJECT DEBUGGING ===');
            console.log('ONNX Runtime (ort):', typeof ort !== 'undefined');
            console.log('MicVAD:', typeof MicVAD !== 'undefined');
            console.log('window.MicVAD:', typeof window.MicVAD !== 'undefined');
            if (typeof MicVAD !== 'undefined') {
                console.log('MicVAD properties:', Object.keys(MicVAD));
            }
            console.log('=== END DEBUGGING ===');
        }

        // Load VAD library with Promise-based approach
        function loadVADLibrary() {
            return new Promise((resolve, reject) => {
                // Try loading the UMD bundle first
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.22/dist/vad.js';
                
                let retryCount = 0;
                const maxRetries = 3;

                function tryLoadingVAD() {
                    console.log(`Attempt ${retryCount + 1} to load VAD...`);
                    
                    setTimeout(() => {
                        if (typeof window.vad !== 'undefined' || typeof window.MicVAD !== 'undefined') {
                            // Library loaded successfully
                            if (typeof window.MicVAD === 'undefined' && typeof window.vad !== 'undefined') {
                                window.MicVAD = window.vad.MicVAD;
                            }
                            console.log('✅ VAD library loaded and initialized successfully');
                            debugWindowObjects();
                            resolve();
                        } else if (retryCount < maxRetries) {
                            retryCount++;
                            tryLoadingVAD();
                        } else {
                            // If all retries failed, try loading the alternative bundle
                            console.log('Trying alternative VAD bundle...');
                            const altScript = document.createElement('script');
                            altScript.src = 'https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.22/dist/bundle.min.js';
                            
                            altScript.onload = () => {
                                setTimeout(() => {
                                    if (typeof window.MicVAD !== 'undefined') {
                                        console.log('✅ Alternative VAD bundle loaded successfully');
                                        debugWindowObjects();
                                        resolve();
                                    } else {
                                        reject(new Error('Failed to load VAD library after all attempts'));
                                    }
                                }, 1000); // Give it a second to initialize
                            };
                            
                            altScript.onerror = () => {
                                reject(new Error('Failed to load alternative VAD bundle'));
                            };
                            
                            document.head.appendChild(altScript);
                        }
                    }, 500); // Half second between retries
                }

                script.onload = () => {
                    console.log('VAD script loaded, checking initialization...');
                    tryLoadingVAD();
                };
                
                script.onerror = () => {
                    console.error('Failed to load primary VAD script, trying alternative...');
                    // Immediately try the alternative bundle
                    const altScript = document.createElement('script');
                    altScript.src = 'https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.22/dist/bundle.min.js';
                    
                    altScript.onload = () => {
                        setTimeout(() => {
                            if (typeof window.MicVAD !== 'undefined') {
                                console.log('✅ Alternative VAD bundle loaded successfully');
                                debugWindowObjects();
                                resolve();
                            } else {
                                reject(new Error('Failed to load VAD library'));
                            }
                        }, 1000);
                    };
                    
                    altScript.onerror = () => {
                        reject(new Error('Failed to load both VAD bundles'));
                    };
                    
                    document.head.appendChild(altScript);
                };
                
                document.head.appendChild(script);
            });
        }

        // Main initialization function
        async function initializeApp() {
            try {
                console.log('Starting app initialization...');
                
                // First, load and initialize VAD
                await loadVADLibrary();
                console.log('VAD library initialized successfully');
                
                // Double check MicVAD is available
                if (!window.MicVAD) {
                    throw new Error('MicVAD not available after initialization');
                }
                
                // Now load the main script
                const mainScript = document.createElement('script');
                mainScript.src = "{{ url_for('static', filename='js/main.js') }}";
                
                // Wait for main script to load
                await new Promise((resolve, reject) => {
                    mainScript.onload = () => {
                        console.log('Main script loaded successfully');
                        resolve();
                    };
                    mainScript.onerror = (error) => {
                        console.error('Failed to load main script:', error);
                        reject(error);
                    };
                    document.body.appendChild(mainScript);
                });
                
            } catch (error) {
                console.error('Error during app initialization:', error);
                // Add visible error message to the page
                const status = document.getElementById('status');
                if (status) {
                    status.textContent = 'Error: Failed to initialize voice detection';
                    status.style.color = 'red';
                }
            }
        }

        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html> 